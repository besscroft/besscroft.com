---
title: "è¶…å–å’Œåˆ†å¸ƒå¼é”è§£å†³æ–¹æ¡ˆ"
date: 2021-05-06T16:08:03+08:00
categories: ["æŠ€æœ¯"]
tags: ["åˆ†å¸ƒå¼é”","Redisson","ä¸‹å•æµç¨‹"]
---

# è¶…å–å’Œåˆ†å¸ƒå¼é”è§£å†³æ–¹æ¡ˆ

### èƒŒæ™¯

è¦è¯´ç°åœ¨åœ¨é«˜å¹¶å‘åœºæ™¯ä¸­ï¼Œå“ªä¸ªæ¦‚å¿µæœ€ç«ï¼Œé‚£å½“å±â€œç§’æ€â€äº†ã€‚é‚£ä¹ˆç§’æ€ä¹Ÿæ˜¯æœ‰è‡ªå·±çš„ä¸€äº›ç‰¹ç‚¹çš„ï¼š

* å¤§é‡ç”¨æˆ·åŒä¸€æ—¶é—´è®¿é—®ï¼Œé€ æˆç¬æ—¶è®¿é—®é‡æ¿€å¢ã€‚
* æ•°æ®åº“çš„å¹¶å‘è¯»å†™æ¿€å¢ï¼Œå¯¼è‡´è´Ÿè½½éå¸¸é«˜ã€‚
* è¯·æ±‚æ•°è¿œå¤§äºåº“å­˜æ•°ï¼Œåªæœ‰éƒ¨åˆ†äººæ‰èƒ½ç§’æ€æˆåŠŸã€‚

å½“ç„¶ï¼Œè¿™ç¯‡æ–‡ç« ä¸å…·ä½“è®²ç§’æ€ç³»ç»Ÿçš„è®¾è®¡äº†ï¼Œä¸»è¦è®²ä¸€è®²åœ¨ç§’æ€ç³»ç»Ÿä¸­çš„ä¸€ç¯â€”â€”Redisåˆ†å¸ƒå¼é”ã€‚è™½ç„¶å•†å®¶éƒ½å¸Œæœ›è‡ªå·±çš„ä¸œè¥¿å–çš„è¶Šå¤šè¶Šå¥½ï¼Œä½†æ˜¯å¤§å¤šæ•°åœºæ™¯ä¸‹ï¼Œç§’æ€çš„åº“å­˜å¹¶ä¸æ˜¯ç‰¹åˆ«å¤šï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±å¾—é¿å…â€œè¶…å–â€é—®é¢˜çš„å‘ç”Ÿäº†ã€‚

## ä¸‹å•çš„æµç¨‹

### æ­£å¸¸ä¸‹å•çš„æµç¨‹

![](/images/tech/2021/redis-distributed-lock-solution/r001.png)

å½“ç”¨æˆ·çš„ä¸‹å•è¯·æ±‚åˆ°è¾¾æœåŠ¡ç«¯æ—¶ï¼Œä¸ºäº†é˜²æ­¢æ¶æ„ä¸‹å•ï¼Œé¦–å…ˆç³»ç»Ÿä¸­è‚¯å®šè¦åšé£æ§çš„ã€‚å¦‚æœè¯´æœ‰å¤§é‡çš„è¯·æ±‚è¿‡æ¥ï¼Œå¯èƒ½éœ€è¦æ¥å£é™æµã€‚ç„¶ååˆ›å»ºè®¢å•ã€åˆ›å»ºæˆåŠŸåæ‰£é™¤åº“å­˜ã€‚è¿™ç§æ–¹æ¡ˆï¼Œç®—æ˜¯æœ€å¸¸è§çš„è§£å†³æ–¹æ¡ˆäº†ã€‚è€Œä¸”ä¹Ÿèƒ½å¤Ÿä¿è¯è®¢å•ä¸ä¼šè¶…å–ï¼Œå› ä¸ºåˆ›å»ºè®¢å•ä¹‹åå°±å‡åº“å­˜ï¼Œå·²ç»å°è£…æˆäº†ä¸€ä¸ªåŸå­æ“ä½œã€‚

> ä½†æ˜¯è¿™æ ·ä¹Ÿæœ‰å¾ˆæ˜æ˜¾çš„ç¼ºç‚¹ï¼šå¹¶å‘é«˜äº†ï¼Œæ“ä½œæ•°æ®åº“çš„æ¬¡æ•°ä¼šå¢åŠ ï¼Œå¯¹æ•°æ®åº“çš„å‹åŠ›ä¸ç”¨æƒ³éƒ½çŸ¥é“å¾ˆé«˜ã€‚

### é¢„æ‰£åº“å­˜

ä¸ºäº†é¿å…æ•°æ®åº“è´Ÿè½½å¢åŠ å¤ªå¤šï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»å‡å°‘æ“ä½œæ•°æ®åº“ IO å…¥æ‰‹ã€‚æ¯”å¦‚è¯´æ‰£åº“å­˜è¿™ä¸€æ“ä½œï¼Œæˆ‘ä»¬å°±æ²¡å¿…è¦ç›´æ¥å»æ•°æ®åº“äº†ï¼Œå¯¹å—ï¼Ÿæˆ‘ä»¬å¯ä»¥æŠŠåº“å­˜ç¼“å­˜åˆ° redis è¿›è¡Œé¢„æ‰£åº“å­˜ã€‚ç„¶åé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ¥å¼‚æ­¥ç”Ÿæˆè®¢å•ï¼Œè¿™æ ·ç”¨æˆ·ç­‰å¾…çš„é€Ÿåº¦å°±ä¼šå¿«å¾ˆå¤šï¼ŒåŒæ—¶ä¹Ÿç»™æ•°æ®åº“å‡å‹äº†ã€‚

![](/images/tech/2021/redis-distributed-lock-solution/r002.png)

è®¢å•çš„ç”Ÿæˆæ˜¯å¼‚æ­¥çš„ï¼Œå’±ä»¬ä¸€èˆ¬éƒ½ä¼šæ”¾åˆ° MQã€kafka è¿™æ ·çš„å³æ—¶æ¶ˆè´¹é˜Ÿåˆ—ä¸­å¤„ç†ï¼Œè®¢å•é‡æ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œç”Ÿæˆè®¢å•éå¸¸å¿«ï¼Œç”¨æˆ·å‡ ä¹ä¸ç”¨æ’é˜Ÿã€‚è€Œä¸”åœ¨ç”µå•†å¹³å°ä¹°ï¼Œè®¢å•éƒ½ä¼šæœ‰ä¸ªè¶…æ—¶æ—¶é—´çš„ï¼Œæ—¶é—´åˆ°äº†æœªæ”¯ä»˜ï¼Œä¼šè‡ªåŠ¨é€€å•ã€‚

### å•æœºä¸‹æ‰£åº“å­˜çš„å¤„ç†

![](/images/tech/2021/redis-distributed-lock-solution/r003.png)

ä¸Šé¢æˆ‘ä»¬è¯´åˆ°äº†ï¼Œä¸‹å•çš„æµç¨‹ä¸­ï¼Œæ˜¯éœ€è¦ä¿è¯æ‰£åº“å­˜å’Œåˆ›å»ºè®¢å•çš„åŸå­æ€§çš„ï¼Œé‚£ä¹ˆåœ¨å•æœºçš„æƒ…å†µä¸‹ï¼Œå°±éœ€è¦ç”¨äº‹åŠ¡æ¥è¿›è¡Œå¤„ç†äº†ã€‚

### åˆ†å¸ƒå¼é”

ç§’æ€çš„åœºæ™¯ï¼Œå¾€å¾€ä¼´éšç€é«˜å¹¶å‘ï¼Œä½†æ˜¯å•æœºçš„æ‰¿è½½èƒ½åŠ›å¹¶ä¸ç®—å¾ˆå¥½ï¼Œè€Œä¸”è¦è€ƒè™‘åˆ°æœåŠ¡çš„å¯ç”¨æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯èƒ½è¦ä¸Šé›†ç¾¤ã€‚åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä¸ºäº†å®ç°ä¸åŒå®¢æˆ·ç«¯çš„çº¿ç¨‹å¯¹ä»£ç å’Œèµ„æºçš„åŒæ­¥è®¿é—®ï¼Œä¿è¯åœ¨å¤šçº¿ç¨‹ä¸‹å¤„ç†å…±äº«æ•°æ®çš„å®‰å…¨æ€§ï¼Œå°±éœ€è¦ç”¨åˆ°åˆ†å¸ƒå¼é”æŠ€æœ¯ã€‚æœ¬ç¯‡æ–‡ç« çš„ä¸»è§’å°±æ¥äº†â€”â€”Redisåˆ†å¸ƒå¼é”ã€‚

è®°å¾—åˆšå­¦åˆ°Javaçš„é”æ¦‚å¿µçš„æ—¶å€™ï¼Œä¸€ä¸ªé€šä¿—æ˜“æ‡‚çš„ä¾‹å­å°±æ˜¯ï¼šä¸€ä¸ªè¿›ç¨‹è¿›å…¥äº†å«redisçš„å•æ‰€ï¼Œä½†æ˜¯å‘ç°å‘æ»¡äº†ï¼ˆä¸Šé”äº†ï¼‰ï¼Œç„¶åå°±åªèƒ½æ”¾å¼ƒä¸Šå•æ‰€ï¼ˆåŠ é”ï¼‰æˆ–è€…ç­‰ä¸€ä¸‹å†çœ‹çœ‹ï¼ˆé‡è¯•ï¼‰ğŸ¤£

> Redis åˆ†å¸ƒå¼é”çš„ä¸‰å¤§æ ¸å¿ƒè¦ç´ å°±æ˜¯ï¼šåŠ é”ã€è§£é”ã€é”è¶…æ—¶ã€‚

é¦–å…ˆï¼Œredis å•æœºå’Œå¤šæœºå®ç°çš„é”ï¼Œæ˜¯ä¸åŒçš„ã€‚ä¸€äº›äººå°†å•æœº Redis æ’é™¤äº†åˆ†å¸ƒå¼é”çš„èŒƒç•´ï¼Œä¸ºäº†é¿å…äº‰è®®ï¼Œè¿™é‡Œæˆ‘ä¹Ÿä¸ç«™è¾¹äº†ã€‚å°±æˆ‘æ‰€äº†è§£çš„ï¼Œæœ‰ä»¥ä¸‹ä¸€äº›æ–¹æ¡ˆï¼š

#### SETNX å‘½ä»¤

ç›´æ¥ä½¿ç”¨ Redis çš„ `SETNX` å‘½ä»¤ï¼Œè¯¥æŒ‡ä»¤åªåœ¨ key ä¸å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œå°† key çš„å€¼è®¾ç½®ä¸º valueï¼Œè‹¥ key å·²ç»å­˜åœ¨ï¼Œåˆ™ SETNX å‘½ä»¤ä¸åšä»»ä½•åŠ¨ä½œã€‚key æ˜¯é”çš„å”¯ä¸€æ ‡è¯†ï¼Œå¯ä»¥æŒ‰ç…§ä¸šåŠ¡éœ€è¦é”å®šçš„èµ„æºæ¥å‘½åã€‚

> è¿™ç§æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œä½†ä¹Ÿå­˜åœ¨å¼Šç«¯ï¼Œä¸‰å¤§æ ¸å¿ƒè¦ç´ çš„é”è¶…æ—¶ç»™æ¼äº†ã€‚ä¸€æ—¦ä¸šåŠ¡åœ¨é‡Šæ”¾é”ä¹‹å‰ï¼Œå‡ºç°äº†é—®é¢˜ï¼Œå°±å¯èƒ½å¯¼è‡´é”æ— æ³•é‡Šæ”¾ï¼Œä»è€Œå¯¼è‡´æ­»é”ã€‚ä½ å¯ä»¥ç†è§£ä¸ºä¸Šå•æ‰€æ—¶çº¸æ‰å‘é‡Œäº†ï¼Œï¼Œï¼Œ

#### EXPIRE å‘½ä»¤

ä¸ºäº†é˜²æ­¢æ­»é”ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ‹¿åˆ°é”ä¹‹åï¼Œç”¨ `EXPIRE` å¯¹ key è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ã€‚è¿™æ ·å°±èƒ½ä¿è¯åœ¨æ²¡æœ‰æ˜¾å¼é‡Šæ”¾çš„æƒ…å†µä¸‹ï¼Œé˜²æ­¢é•¿æ—¶é—´è¢«ç‹¬å ï¼Œå› ä¸ºæ—¶é—´åˆ°äº†é”ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚

> æ²¡é”™ï¼Œå³ä½¿å®ç°äº†ä¸‰å¤§æ ¸å¿ƒè¦ç´ ï¼Œä¾æ—§å­˜åœ¨ç€ä¸€äº›é—®é¢˜ã€‚å¾ˆæ˜æ˜¾çš„ï¼ŒåŠ é”å‘½ä»¤å’Œè®¾ç½®è¶…æ—¶æ—¶é—´çš„å‘½ä»¤ï¼Œæ˜¯éåŸå­æ€§çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœåœ¨æ‰§è¡Œ SETNX å’Œ EXPIRE ä¹‹é—´å‘ç”Ÿå¼‚å¸¸ï¼Œä»ç„¶å¯èƒ½ä¼šå¯¼è‡´é”çš„è¶…æ—¶ã€‚

#### ä½¿ç”¨ SET æŒ‡ä»¤æ‰©å±•

ä¸ºäº†è§£å†³å‰é¢å‡ºç°çš„åŸå­æ€§é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `SET` æŒ‡ä»¤çš„æ‰©å±•å‚æ•°æ¥è§£å†³ã€‚ä½†æ˜¯åŒæ—¶å¼•æ¥äº†ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼š**é”å¯èƒ½è¢«æå‰é‡Šæ”¾äº†**ã€‚æˆ‘ä¸¾ä¸ªä¾‹å­ï¼Œçº¿ç¨‹ A åŠ é”åï¼Œè®¾å®šçš„è¶…æ—¶æ—¶é—´æ˜¯ 5s ï¼Œä½†æ˜¯å¤„äºæŸäº›æ„å¤–ï¼Œæ‰§è¡Œæ—¶é—´ä¸º 6sã€‚ä½†æ˜¯è¿™æ—¶å€™é”å·²ç»æ—©å°±è‡ªåŠ¨é‡Šæ”¾äº†ï¼ŒåŒæ—¶è¢«çº¿ç¨‹ B ç»™æŠ¢å äº†ã€‚ä½†æ˜¯çº¿ç¨‹ A ä¾æ—§é‡Šæ”¾äº†é”ï¼Œä¹Ÿå°±å¯¼è‡´äº†**é”™è¯¯é‡Šæ”¾äº†é”**ã€‚

ä½†æ˜¯ä¹Ÿä¸æ˜¯æ— æ³•è§£å†³çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç»™æ¯ä¸ªé”è®¾ç½®ä¸€ä¸ªå”¯ä¸€çš„æ ‡è®°ã€‚åˆ«å¿˜äº† redis æ˜¯ key-value å½¢å¼çš„ã€‚æˆ‘ä»¬åŠ é”ï¼Œæ˜¯åŠ åˆ° key ä¸Šé¢å»äº†ï¼Œä½†æ˜¯æˆ‘ä»¬åŒæ ·çš„å¯ä»¥åœ¨ value ä¸Šé¢ï¼Œè®¾ç½®å”¯ä¸€çš„æ ‡è¯†ã€‚ç„¶ååœ¨é‡Šæ”¾é”ä¹‹å‰éªŒè¯ä¸€ä¸‹ï¼Œå¦‚æœå½“å‰é”çš„ value å’Œæˆ‘åŠ ä¸Šå»çš„ value ä¸€æ ·ï¼Œé‚£æˆ‘ä»¬å°±é‡Šæ”¾ã€‚

> åˆåŒå’å•æ–°é—®é¢˜äº†ï¼ˆé€æ¸æš´èºï¼‰ï¼Œåˆ¤æ–­ value å’Œåˆ é™¤ key æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„æ“ä½œï¼Œæ‰€ä»¥è‚¯å®šæ— æ³•ä¿è¯åŸå­æ€§ã€‚

#### ä½¿ç”¨ lua è„šæœ¬

ä¸ºäº†ä¿è¯åˆ¤æ–­ value å’Œåˆ é™¤ key çš„åŸå­æ€§ï¼Œæˆ‘ä»¬å°±éœ€è¦ç”¨åˆ° lua è„šæœ¬è¿›è¡Œå¤„ç†äº†ï¼Œlua è„šæœ¬å¯ä»¥ä¿è¯è¿ç»­å¤šä¸ªæŒ‡ä»¤çš„åŸå­æ€§æ‰§è¡Œã€‚

```lua
if redis.call("get",KEYS[1]) == ARGV[1] then
    return redis.call("del",KEYS[1])
else
    return 0
end
```

> lua è„šæœ¬è§£å†³äº†é”™è¯¯é‡Šæ”¾é”çš„é—®é¢˜ï¼Œä½†æ˜¯å´ä¾æ—§æ²¡è§£å†³æå‰é‡Šæ”¾é”çš„é—®é¢˜ã€‚

#### Redlock

Redlock æœ¬è´¨ä¸Šæ˜¯ä½¿ç”¨ Redis å®ç°åˆ†å¸ƒå¼é”çš„è§„èŒƒç®—æ³•ï¼Œå®ƒæœ‰å¾ˆå¤šå®ç°ï¼Œæˆ‘ä»¬å¸¸è§çš„ Redisson å°±æ˜¯å…¶ä¸­ä¸€ä¸ªã€‚ä½†æ˜¯ Redlock äº‰è®®ä¹Ÿæ˜¯æœ‰çš„ï¼Œè´´å‡ ä¸ªé“¾æ¥å¤§å®¶è‡ªå·±å»çœ‹å§ï¼š

https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html

http://antirez.com/news/101

https://redis.io/topics/distlock

https://carlosbecker.com/posts/distributed-locks-redis/

ä¸»è¦æ˜¯å…³äºå®‰å…¨æ€§æ–¹é¢çš„ä¸€äº›äº‰è®®ï¼Œä¸è¿‡å¯¹äºå¤§å¤šæ•°åœºæ™¯æ¥è¯´ï¼Œå…¶å®æ˜¯å®Œå…¨å¤Ÿç”¨äº†ã€‚

#### åŸºäºJava å®ç°çš„ Redisson

![](/images/tech/2021/redis-distributed-lock-solution/r004.png)

è¿™æ˜¯ä¸€å¼ ç½‘å›¾ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥çœ‹å‡ºå·¥ä½œæœºåˆ¶ã€‚

Redisson æ˜¯ä¸€ä¸ªåœ¨Redisçš„åŸºç¡€ä¸Šå®ç°çš„Javaé©»å†…å­˜æ•°æ®ç½‘æ ¼ï¼ˆIn-Memory Data Gridï¼‰ã€‚å®ƒä¸ä»…æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼çš„Javaå¸¸ç”¨å¯¹è±¡ï¼Œè¿˜æä¾›äº†è®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ã€‚

å®˜æ–¹æ–‡æ¡£åœ°å€ï¼šhttps://github.com/redisson/redisson/wiki/%E7%9B%AE%E5%BD%95